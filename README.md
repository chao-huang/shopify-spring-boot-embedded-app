# The How

Note: This Spring Security application requires the Java Cryptography Encryption policy files for encryption.

See https://www.oracle.com/technetwork/java/javase/downloads/jce-all-download-5170447.html

***************************************

### `ShopifyOriginFilter`
- If the request is to the application installation path, this filter sets a `ShopifyOriginToken` as the `Authentication` object if it is determined that the request came from Shopify (and if there is no "Shopify" Authentication object already).
- If the request is to what Shopify calls the "whitelisted redirection url", and if the request did not come from Shopify, a 403 response is sent via the AccessDeniedHandler.

### `ShopifyExistingTokenFilter`
- This filter matches the installation endpoint path (/install)
- If there is a `ShopifyOriginToken` as the `Authentication`, attempt to replace it with a `OAuth2PersistedAuthenticationToken` retrived from the `TokenService`. This will be successful only if this store has already been installed. As a side note, the only way this path can be reached with an `ShopifyOriginToken` is in the embedded app scenario, where Shopify itself invokes the installation uri.
- If none exists (the store has not been installed as an embedded app or this call is comming as a regular request), this filter will not modify the `Authentication` in the `SecurityContextHolder`.

### `ShopifyOAuth2AuthorizationRequestResolver`
- Replaces the default: `DefaultOAuth2AuthorizationRequestResolver`
- Invoked by `OAuth2AuthorizationRequestRedirectFilter`.
- By default, this class will match any request that matches "/install/shopify".
- Its `resolve(...)` method always returns null to override the filter's default redirection behavior.
- If the user is authenticated (via `OAuth2PersistedAuthenticationToken`) or if the shop parameter is not provided (if this is not from the embedded app, we at least need the shop name to initiate the OAuth flow with Shopify), then this class does nothing else.
- If not, this resolver... 
	1. Looks for a `ClientRegistration` that matches "/install/shopify".
	2. Creates an `OAuth2AuthorizationRequest`:
		- clientId: from `ClientRegistration`
		- authorizationUri: uses the "shop" parameter in the request to populate the uri template variable in the authorizationUri stored in the `ProviderDetails` in the `ClientRegistration` (default: "https://{shop}/admin/oauth/authorize")
		- redirectUri: expands and populates the uri template in ClientRegistrarion (default: "{baseUrl}/login/app/oauth2/code/shopify")
		- scopes: from `ClientRegistration`
		- state: generated by `Base64StringKeyGenerator`
		- additionalParameters: contains the registrationId, and the shop name
	3. Uses the custom `ShopifyHttpSessionOAuth2AuthorizationRequestRepository` to save the `OAuth2AuthorizationRequest` in the HttpSession
	4. Invokes the `ShopifyRedirectStrategy` to set an `AuthenticationRedirectUriHolder` in the `Authentication`. This temporary object contains the 2 authorizationUris that the Shopify-provided Javascript needs to redirect: one for redirecting from the parent and another for redirecting from an iFrame.


The `OAuth2LoginAuthenticationFilter`/`AbstractAuthenticationProcessingFilter` matches the default "{baseUrl}/login/app/oauth2/code/shopify" and...
1. Retrieves and removes the `OAuth2AuthorizationRequest` saved by `ShopifyHttpSessionOAuth2AuthorizationRequestRepository`
2. Builds an `OAuth2AuthorizationResponse` from the Shopify response parameters
3. Builds an `OAuth2AuthorizationExchange` that contains the `OAuth2AuthorizationRequest` and `OAuth2AuthorizationResponse` 
4. Uses the `OAuth2AuthorizationExchange` along with the corresponding Shopify `ClientRegistration` to build an `OAuth2LoginAuthenticationToken`
5. Delegates to `OAuth2LoginAuthenticationProvider`, which returns a `OAuth2LoginAuthenticationToken`
6. Uses the `OAuth2LoginAuthenticationToken` to create an `OAuth2AuthenticationToken` and an `OAuth2AuthorizedClient`
7. Uses the default `AuthenticatedPrincipalOAuth2AuthorizedClientRepository` (which uses the custom `ShopifyOAuth2AuthorizedClientService`) to save the `OAuth2AuthorizedClient`
8. Calls `sessionStrategy.onAuthentication(...)` on the default `NullAuthenticatedSessionStrategy` (does nothing)
9. Calls `successfulAuthentication(...)` which sets the authentication in the `SecurityContextHolder`, takes care of other services, and finally delegates to the custom `NoRedirectSuccessHandler` successHandler



The default `OAuth2LoginAuthenticationProvider`...
1. Uses a custom `OAuth2AccessTokenResponseClient`: `ShopifyAuthorizationCodeTokenResponseClient` to get a `OAuth2AccessTokenResponse`
2. Asks the custom implementation of `OAuth2UserService<OAuth2UserRequest, OAuth2User>` userService), `DefaultShopifyUserService`, to load the `OAuth2User`.
3. Returns a `OAuth2LoginAuthenticationToken` using the `ClientRegistration`, `AuthorizationExchange`, `OAuth2User`, ...



### `ShopifyAuthorizationCodeTokenResponseClient`
- Replaces the default: `DefaultAuthorizationCodeTokenResponseClient`.
- Invoked by the default `OAuth2LoginAuthenticationProvider`
- Delegates to the default, but first replaces the `OAuth2AccessTokenResponseHttpMessageConverter` with `CustomOAuth2AccessTokenResponseHttpMessageConverter`
- Rewrites every `ClientRegistration`'s tokenUri before delegating to the default, since in Shopify, each tokenUri is unique to the store.
- Before returning the response, it adds the shop name as an additional parameter to the `OAuth2AccessTokenResponse`


### `CustomShopifyOAuth2AccessTokenResponseHttpMessageConverter`
- Replaces the default: `OAuth2AccessTokenResponseHttpMessageConverter`
- Invoked by `DefaultAuthorizationCodeTokenResponseClient`
- The default converter expects a "token_type" parameter in the response along with the token, but Shopify does not send it. Also, Shopify sends the scope as a string delimited by ", " instead of the default " ". This converter takes care of these issues.



### `ShopifyHttpSessionOAuth2AuthorizationRequestRepository`*
- "Replaces" the default: `HttpSessionOAuth2AuthorizationRequestRepository`
- Invoked by `ShopifyOAuth2AuthorizationRequestResolver`
- In the `ShopifyOauth2AuthorizationRequestResolver`, when we call the requestRepository's `saveAuthorizationRequest()` method, we don't have an `HttpServletResponse`. `ShopifyHttpSessionOAuth2AuthorizationRequestRepository` is functionally identical but with a different method signature


### `ShopifyRedirectStrategy`*
- "Replaces" the default:` DefaultRedirectStrategy`
- Invoked by `ShopifyOAuth2AuthorizationRequestResolver`
- It does not redirect
- It populates `Authentication` with a `AuthenticationRedirectUriHolder`, which contains the redirection URIs the Javascript will use to redirect. This allows for "redirecting" from an iFrame in an embedded app setting.


* Note: The classes they replace would be invoked in the `OAuth2LoginAuthenticationFilter`, but since they are not (by the resolver always returning null), these are their functional equivalents in the resolver



### `DefaultShopifyUserService`
- Replaces the `DefaultOAuth2UserService`
- Invoked by `OAuth2LoginAuthenticationProvider`
- Instead of making a request for UserInfo, this implementation instantiates a `ShopifyStore` that contains the name of the store, and its access token, and returns it to the provider
- The shop name is retrieved from the `OAuth2UserRequest` that was passed in. The `ShopifyAuthorizationCodeTokenResponseClient` set it as an additional parameter in the `OAuth2AccessTokenResponse`, whose additional parameters are used to create a `OAuth2UserRequest`


### `NoRedirectSuccessHandler`
- Replaces/decorates the default: `SavedRequestAwareAuthenticationSuccessHandler`
- Since we can't redirect in an embedded app, an "empty" redirect strategy is given to `SavedRequestAwareAuthenticationSuccessHandler`
- This handler delegates to `SavedRequestAwareAuthenticationSuccessHandler` for cleanup, and to take care of everything, except for redirecting.


### `ShopifyOAuth2AuthorizedClientService`
- Replaces the default: `InMemoryOAuth2AuthorizedClientService` (as stipulated by `OAuth2ClientConfigurerUtils`)
- Invoked by `OAuth2LoginAuthenticationFilter` when it invokes the default `AuthenticatedPrincipalOAuth2AuthorizedClientRepository` after a user has authenticated
- Instead of saving them in memory, this implementation attempts to use the custom tokenService to save the store in a database



***********************************

TODO
1. Write test for ShopifyVerificationStrategy
2. Finish the ShopifyVerificationStrategy